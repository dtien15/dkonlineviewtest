<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bàn phím ảo tiếng Việt</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/simple-keyboard/3.8.30/css/index.css"
    />
    <style>
      .simple-keyboard {
        display: none;
        max-width: 700px;
        margin: 1rem auto;
        /* Cho phép bắt sự kiện mà không blur input */
        user-select: none;
      }
      .input-group {
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <p>Chọn kiểu gõ:</p>
    <label
      ><input
        type="radio"
        name="vnkeys_method"
        value="auto"
        checked
        onchange="VNKeys.setMethod();"
      />
      AUTO</label
    >
    <label
      ><input
        type="radio"
        name="vnkeys_method"
        value="telex"
        onchange="VNKeys.setMethod();"
      />
      TELEX</label
    >
    <label
      ><input
        type="radio"
        name="vnkeys_method"
        value="vni"
        onchange="VNKeys.setMethod();"
      />
      VNI</label
    >

    <div class="input-group">
      <label for="inpName">Họ và tên:</label>
      <input
        id="inpName"
        type="text"
        data-vnkeys
        placeholder="Nhập họ tên..."
        style="width: 100%; padding: 0.5rem"
      />
    </div>
    <div class="input-group">
      <label for="inpAddr">Địa chỉ:</label>
      <input
        id="inpAddr"
        type="text"
        data-vnkeys
        placeholder="Nhập địa chỉ..."
        style="width: 100%; padding: 0.5rem"
      />
    </div>

    <div class="simple-keyboard"></div>

    <!-- VNKeys-JS: tự scan các thẻ data-vnkeys -->
    <script src="https://vnkeys.net/raw.htm?skey=vnkeys_js"></script>
    <!-- simple-keyboard -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-keyboard/3.8.30/index.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        VNKeys.setMethod("auto");

        const Keyboard = window.SimpleKeyboard.default;
        const keyboard = new Keyboard({
          onKeyPress: (btn) => handleKeyPress(btn),
        });

        let activeInput = null;
        const kbContainer = document.querySelector(".simple-keyboard");

        // Chặn blur khi mousedown lên bàn phím
        kbContainer.addEventListener("mousedown", (e) => e.preventDefault());

        function handleKeyPress(btn) {
          if (!activeInput) return;

          // 1) Xử lý Shift / CapsLock
          if (btn === "{shift}" || btn === "{lock}") {
            const newLayout =
              keyboard.options.layoutName === "default" ? "shift" : "default";
            keyboard.setOptions({ layoutName: newLayout });
            return;
          }

          const start = activeInput.selectionStart;
          const end = activeInput.selectionEnd;
          let val = activeInput.value;

          // 2. Xử lý backspace
          if (btn === "{bksp}") {
            if (start > 0 && start === end) {
              val = val.slice(0, start - 1) + val.slice(end);
              activeInput.setSelectionRange(start - 1, start - 1);
            } else {
              val = val.slice(0, start) + val.slice(end);
              activeInput.setSelectionRange(start, start);
            }
          }
          // 3. Xử lý space
          else if (btn === "{space}") {
            val = val.slice(0, start) + " " + val.slice(end);
            activeInput.setSelectionRange(start + 1, start + 1);
          }
          // 4. Chèn ký tự thường
          else if (!btn.startsWith("{")) {
            val = val.slice(0, start) + btn + val.slice(end);
            activeInput.setSelectionRange(
              start + btn.length,
              start + btn.length
            );
          } else {
            // những phím khác (enter, shift…) có thể xử lý tương tự nếu cần
            return;
          }

          // 5. Cập nhật giá trị và emit 'input' để VNKeys-JS convert Telex/VNI
          activeInput.value = val;
          activeInput.dispatchEvent(new Event("input", { bubbles: true }));

          // 6. Giữ focus để gõ tiếp
          activeInput.focus();

          // 7. Đồng bộ UI của simple-keyboard
          keyboard.setInput(activeInput.value);
        }

        // Gắn sự kiện cho tất cả input[data-vnkeys]
        document.querySelectorAll("[data-vnkeys]").forEach((inp) => {
          inp.addEventListener("focus", () => {
            activeInput = inp;
            keyboard.setInput(inp.value);
            kbContainer.style.display = "block";
          });
          inp.addEventListener("input", () => {
            if (activeInput === inp) keyboard.setInput(inp.value);
          });
        });

        // Click ra ngoài → ẩn bàn phím
        document.addEventListener("click", (e) => {
          if (
            !e.target.closest(".simple-keyboard") &&
            !e.target.matches("[data-vnkeys]")
          ) {
            kbContainer.style.display = "none";
            activeInput = null;
          }
        });
      });
    </script>
  </body>
</html>

<input
  type="text"
  id="ageInput"
  inputmode="numeric"
  pattern="\d*"
  data-vnkeys
/>
